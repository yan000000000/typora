# BMI088

### 引入

本节课将介绍 BMI088 传感器的相关知识，BMI088 传感器是一个六轴惯性测量单元 (IMU)，能够应用于机器人上的姿态解算，将在本章节学习六轴惯性测量单元的内部结构——三轴陀螺仪和三轴加速度计，惯性测量单元的功能及其基本原理，同时我们将介绍一个重要的通信协议——SPI 协议，以及 BMI088 传感器的使用方法，并编写工程进行 BMI088 传感器的驱动。

### 陀螺仪

Bosch 公司生产的 BMI088 高性能惯性测量单元 (IMU) 专门设计用于无人机和机器人应用。该款 6 轴传感器在 3 x 4.5 x 0.95mm³小尺寸 LGA 封装中集成了 16 位 ADC 精度的三轴陀螺仪和三轴加速度计。

陀螺仪是测量角速度的传感器，是 IMU 的重要组成部分。陀螺仪能测量在三个正交方向上旋转的角速度，也可以用于估算在三个方向上的旋转角度。

陀螺仪有许多种类，不同的陀螺仪一般基于不同的工作原理，能够达到的精度也不一样，市场上最常用的微机电（MEMS）陀螺仪的基本原理是利用旋转时产生的科里奥利力引发电容的变化，从而将旋转的角速度转化为电信号。

### 加速度计

六轴 IMU 中的另一重要组成部分是加速度计；顾名思义，加速度计能够测量三个正交方向上的加速度。MEMS 加速度计原理是利用加速度变化使内部质量块产生的力发生变化，从而改变电容大小，转化为电信号。当物体静止时，加速度计测量重力加速度在三个正交方向上的分量，配合陀螺仪的角速度信息可以解算出物体的空间位姿，详细的解算过程可以参考第 18 章姿态解算任务章节。

### SPI协议

BMI088 支持 SPI 协议和 I2C 协议，通过 PS 引脚的电平状态决定是 SPI 协议或者 I2C 协议

![image-20240530211645835](.assets/image-20240530211645835.png)

当BMI088使用SPI协议时，各个管脚的功能可见下表

![image-20240530211704768](.assets/image-20240530211704768.png)

SPI 协议是摩托罗拉公司开发的一种高速的，全双工，同步的通信总线，使用四根线进行通信，具有简单易用，通讯速度高的特点。SPI 总线上可以挂载多个设备，这些设备被区分成主设备（Master）和从设备（Slave），主设备通过时钟线和片选线对从设备进行控制。SPI 协议所使用到的引脚及其功能见下表

![image-20240530211806536](.assets/image-20240530211806536.png)

SPI 是一种全双工的通信协议，主设备和从设备通信时，两端的收发是同步进行的，即主设备和从设备在向对方发送数据的同时，也在接收对方发来的数据。

SPI 的通信过程如下：

1. 主设备将要进行通讯的从设备的 SS/CS 片选拉低，
2. 主设备通过 SCK 向从设备提供同步通讯所需要的时钟信号

3. 主设备通过 MOSI 向从设备发送 8 位数据，同时通过 MISO 接收从设备发来的 8 位数据。

4. 通信结束，主设备拉高 SS/CS 片选。详细的 SPI 总线的连接方法和通信过程介绍可以见进阶学习部分。

### CubeMX配置

1. 我们首先打开C型开发板用户手册，在附表中找到6轴IMU(BMI088)，可以找到它对应的IO接口

![image-20240530213737936](.assets/image-20240530213737936.png)

2. 打开CubeMX，在Connectivity菜单栏中找到SPI1，进入它的配置页面，将模式选择为Full-Duplex Master，即让stm32工作在全双工SPI下，作为主机使用，将硬件片选信号Hardware NSS Signal 设为Disable。

![image-20240530213935448](.assets/image-20240530213935448.png)

3. 在下面的Configuration中，我们修改预分频值为256， 时钟优先级为High， Clock Phase为2 Edge

![image-20240530214240657](.assets/image-20240530214240657.png)

这里我们顺带介绍一下配置界面中的重要参数

| 参数                         | 功能                                                   |
| ---------------------------- | ------------------------------------------------------ |
| Frame Format                 | 设置SPI帧格式，可选Motorol摩托罗拉格式和TI德州仪器格式 |
| Data Size                    | 一帧中的数据长度，一般选为8bit                         |
| First Bit                    | 发送时先发最高位MSB还是最低位LSB                       |
| Prescaler                    | 总线分频值，设置SPI的通讯时钟频率                      |
| Clock Polarity & Clock Phase | 用于设置SPI的时序功能                                  |
| CRC Calculation              | CRC校验计算功能                                        |
| NSS Signal Type              | 片选信号类型                                           |

4. 打开System Core菜单栏下的GPIO选项栏，在SPI选项卡下，我们找到目前设置的SPI模式对应的引脚配置。可以发现CubeMX默认开启PB5作为SPI1_MOSI，于用户手册中的选择不同。我们需要将它修改成PA7引脚。

![image-20240530214631167](.assets/image-20240530214631167.png)

![image-20240530214657387](.assets/image-20240530214657387.png)

5. 之后完成我们基本的配置就可以选择Generate Code生成代码啦